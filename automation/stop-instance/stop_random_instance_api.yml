---
description: Stop instances in a particular AZ with tag filter
schemaVersion: '0.3'
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  AvailabilityZone:
    type: String
    description: "(Required) The Availability Zone to impact"
  TagName:
    type: String
    description: "The tag name to filter instances"
  TagValue:
    type: String
    description: "The tag value to filter instances"
  AutomationAssumeRole:
    type: String
    description: "(Optional) The ARN of the role that allows Automation to perform
      the actions on your behalf."
mainSteps:
- name: listInstances
  action: aws:executeAwsApi
  timeoutSeconds: 60
  inputs:
    Service: ec2
    Api: DescribeInstances
    Filters:
    -  Name: availability-zone
       Values: ["{{ AvailabilityZone }}"]
    -  Name: instance-state-name
       Values: ["running"]
    -  Name: tag:{{ TagName }}
       Values: ["{{ TagValue }}"]
  outputs:
    - Name: InstanceIds
      Selector: "$.Reservations..Instances..InstanceId"
      Type: StringList
- name: verifyInstanceStateRunning
  action: aws:waitForAwsResourceProperty
  timeoutSeconds: 60
  inputs:
    Service: ec2
    Api: DescribeInstanceStatus
    InstanceIds:
      - "{{ listInstances.InstanceIds }}"
    PropertySelector: "$.InstanceStatuses[0].InstanceState.Name"
    DesiredValues:
      - running
- name: stopInstances
  action: aws:changeInstanceState
  onFailure: Continue
  inputs:
    InstanceIds: "{{ listInstances.InstanceIds }}"
    DesiredState: stopped
- name: forceStopInstances
  action: aws:changeInstanceState
  inputs:
    InstanceIds: "{{ listInstances.InstanceIds }}"
    CheckStateOnly: false
    DesiredState: stopped
    Force: true
- name: verifyInstanceStateStopped
  action: aws:waitForAwsResourceProperty
  timeoutSeconds: 60
  inputs:
    Service: ec2
    Api: DescribeInstanceStatus
    IncludeAllInstances: true
    InstanceIds:
      - "{{ listInstances.InstanceIds }}"
    PropertySelector: "$.InstanceStatuses[0].InstanceState.Name"
    DesiredValues:
      - stopped
      - terminated

outputs:
- "listInstances.InstanceIds"